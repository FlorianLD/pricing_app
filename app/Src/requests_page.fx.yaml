requests_page As screen:
    Fill: =RGBA(247, 247, 247, 247)
    LoadingSpinnerColor: =App.Theme.Colors.Primary

    "GalleryRequests As gallery.'BrowseLayout_Vertical_TwoTextOneImageVariant_ver5.0'":
        BorderColor: =App.Theme.Colors.Darker40
        DelayItemLoading: =true
        Fill: =Color.White
        Height: =425
        Items: |-
            =Sort(
                Filter(
                    requests,
            
                    // If the searchbar is not empty, look for the product that has a matching name or ID
                    If(
                        !IsBlank(searchBar_request.Input), 
                        Or(
                            product_id = LookUp(product_data, name = searchBar_request.Input, id), 
                            Text(product_id) = searchBar_request.Input
                            ), 
                            true
                    ) &&
            
                    If(
                        filterDD_Status.SelectedValue <> "All",
                        status = filterDD_Status.SelectedValue, 
                        true
                    ) &&
            
                    If(
                        filterDD_Employee.SelectedValue = "My requests",
                        employee_id = CurrentUserId,
                        true
                    )
                ),
                request_date,
                SortOrder.Descending
            )
        Layout: =Layout.Vertical
        LoadingSpinner: =LoadingSpinner.Data
        TemplatePadding: =0
        TemplateSize: =110
        Width: =756
        X: =304
        Y: =237
        ZIndex: =1

        Rectangle3_2 As rectangle:
            BorderColor: =App.Theme.Colors.Darker40
            Fill: =App.Theme.Colors.Darker30
            Height: =Parent.TemplateHeight - Separator3_2.Height
            OnSelect: =Select(Parent)
            Visible: =ThisItem.IsSelected
            Width: =4
            ZIndex: =1

        reqProductImg As image:
            BorderColor: =App.Theme.Colors.Darker40
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledFill: =RGBA(244, 244, 244, 1)
            Height: =80
            OnSelect: =Select(Parent)
            RadiusBottomLeft: =8
            RadiusBottomRight: =8
            RadiusTopLeft: =8
            RadiusTopRight: =8
            Width: =72
            X: =16
            Y: =24
            ZIndex: =2

        Title6_2 As label:
            Color: =RGBA(50, 49, 48, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =App.Theme.Font
            FontWeight: =If(ThisItem.IsSelected, FontWeight.Semibold, FontWeight.Normal)
            Height: =20
            OnSelect: =Select(Parent)
            PaddingBottom: =0
            PaddingLeft: =0
            PaddingRight: =0
            PaddingTop: =0
            Text: =
            VerticalAlign: =VerticalAlign.Top
            Visible: =false
            Width: =256
            X: =103
            Y: =24
            ZIndex: =3

        reqReviewDate As label:
            Color: =RGBA(0, 0, 0, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =App.Theme.Font
            FontWeight: =If(ThisItem.IsSelected, FontWeight.Semibold, FontWeight.Normal)
            Height: =Self.Size * 1.8
            OnSelect: =Select(Parent)
            PaddingBottom: =0
            PaddingLeft: =0
            PaddingRight: =0
            PaddingTop: =0
            Size: =12
            Text: |-
                ="Reviewed: "&DateValue(ThisItem.review_date)
            VerticalAlign: =VerticalAlign.Top
            Width: =Title6_2.Width
            X: =103
            Y: =82
            ZIndex: =5

        reqCreationDate As label:
            Color: =RGBA(0, 0, 0, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =App.Theme.Font
            FontWeight: =If(ThisItem.IsSelected, FontWeight.Semibold, FontWeight.Normal)
            Height: =Self.Size * 1.8
            OnSelect: =Select(Parent)
            PaddingBottom: =0
            PaddingLeft: =0
            PaddingRight: =0
            PaddingTop: =0
            Size: =12
            Text: |-
                ="Created: "&DateValue(ThisItem.request_date)
            VerticalAlign: =VerticalAlign.Top
            Width: =Title6_2.Width
            X: =103
            Y: =58
            ZIndex: =6

        reqProductName As label:
            Color: =RGBA(0, 0, 0, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =App.Theme.Font
            FontWeight: =If(ThisItem.IsSelected, FontWeight.Semibold, FontWeight.Normal)
            Height: =34
            OnSelect: =Select(Parent)
            PaddingBottom: =0
            PaddingLeft: =0
            PaddingRight: =0
            PaddingTop: =0
            Size: =12
            Text: |-
                ="Product: "&LookUp(product_data, id = ThisItem.product_id, name)
            VerticalAlign: =VerticalAlign.Top
            Width: =153
            X: =103
            Y: =24
            ZIndex: =7

        Separator3_2 As rectangle:
            BorderColor: =App.Theme.Colors.Darker40
            Fill: =RGBA(255, 255, 255, 1)
            Height: =0
            OnSelect: =Select(Parent)
            Width: =Parent.TemplateWidth
            Y: =109
            ZIndex: =8

        StatusTag As Button:
            AcceptsFocus: =false
            Align: =Align.Center
            Appearance: ='ButtonCanvas.Appearance'.Primary
            BasePaletteColor: |-
                =Switch(
                    ThisItem.status,
                    "Accepted", Color.Green,
                    "Pending", Color.Orange,
                    "Rejected", Color.Red,
                    Color.Gray
                )
            BorderRadiusBottomLeft: =10
            BorderRadiusBottomRight: =10
            BorderRadiusTopLeft: =10
            BorderRadiusTopRight: =10
            DisplayMode: =DisplayMode.Edit
            FontSize: =9
            Height: =18
            OnSelect: =false
            PaddingBottom: =6
            Text: =ThisItem.status
            VerticalAlign: =VerticalAlign.Middle
            Width: =65
            X: =256
            Y: =26
            ZIndex: =9

        BtnSeeReq As Button:
            Appearance: ='ButtonCanvas.Appearance'.Transparent
            DisplayMode: =DisplayMode.Edit
            FontSize: =30
            Height: =35
            Icon: ="ChevronRight"
            OnSelect: |-
                =Set(showElement, true);
                
                Set(CurrentRequestProductId, ThisItem.product_id);
                Set(CurrentRequestOldPrice, ThisItem.old_price);
                Set(CurrentRequestNewPrice, ThisItem.new_price);
                Set(CurrentRequestStatus, ThisItem.status);
                Set(CurrentRequestId, ThisItem.id);
                Set(CurrentRequestCreationDate, ThisItem.request_date);
                Set(CurrentRequestReviewDate, ThisItem.review_date);
                Set(CurrentRequestEmployeeId, ThisItem.employee_id);
                
                Reset(reviewComment);
            Text: =
            Width: =35
            X: =701
            Y: =37
            ZIndex: =10

    MsgNoRequestFound As Text:
        Align: ='TextCanvas.Align'.Center
        DisplayMode: =DisplayMode.Edit
        Height: =96
        Size: =28
        Text: ="No request found with the current filter"
        VerticalAlign: ='TextCanvas.VerticalAlign'.Middle
        Visible: |-
            =If(
                GalleryRequests.AllItemsCount = 0,
                true,
                false
            )
        Width: =496
        X: =435
        Y: =396
        ZIndex: =2

    my_header_3 As my_header:
        ZIndex: =3

    refreshBtn_2 As Button:
        Appearance: ='ButtonCanvas.Appearance'.Transparent
        DisplayMode: =DisplayMode.Edit
        FontColor: =RGBA(106, 122, 127, 1)
        FontSize: =24
        Height: =31
        Icon: ="ArrowClockwise"
        OnSelect: =Refresh(requests)
        Text: =
        Width: =28
        X: =1023
        Y: =662
        ZIndex: =16

    requestInfoGroup As group:
        Height: =5
        Width: =5
        X: =40
        Y: =40
        ZIndex: =21

        modal_opacity_2 As rectangle:
            BorderColor: =App.Theme.Colors.Darker40
            Fill: =RGBA(0, 0, 0, 50%)
            Height: =768
            Visible: =showElement
            Width: =1366
            ZIndex: =13

        requestInfo As groupContainer.manualLayoutContainer:
            BorderColor: =RGBA(189, 49, 51, 1)
            DropShadow: =DropShadow.Light
            Fill: =Color.White
            Height: =523
            RadiusBottomLeft: =4
            RadiusBottomRight: =4
            RadiusTopLeft: =4
            RadiusTopRight: =4
            Visible: =showElement
            Width: =377
            X: =490
            Y: =152
            ZIndex: =14

            Rectangle7_1 As rectangle:
                BorderColor: =
                Fill: =App.Theme.Colors.Darker40
                Height: =49
                Width: =377
                ZIndex: =1

            FormHeader_1 As Text:
                Align: ='TextCanvas.Align'.Center
                DisplayMode: =DisplayMode.Edit
                FontColor: =RGBA(255, 255, 255, 1)
                Height: =35
                PaddingLeft: =0
                Size: =20
                Text: ="Request info"
                Width: =235
                X: =70
                Y: =5
                ZIndex: =2

            TextCanvas5_20 As Text:
                DisplayMode: =DisplayMode.Edit
                Height: =32
                Text: |-
                    ="Old price: "
                Weight: ='TextCanvas.Weight'.Semibold
                Width: =100
                X: =FormAlignment
                Y: =230
                ZIndex: =3

            TextCanvas5_16 As Text:
                DisplayMode: =DisplayMode.Edit
                Height: =32
                Text: |-
                    ="Product ID:"
                Weight: ='TextCanvas.Weight'.Semibold
                Width: =100
                X: =FormAlignment
                Y: =180
                ZIndex: =4

            TextCanvas5_18 As Text:
                DisplayMode: =DisplayMode.Edit
                Height: =32
                Text: |-
                    ="Review date:"
                Weight: ='TextCanvas.Weight'.Semibold
                Width: =100
                X: =FormAlignment
                Y: =139
                ZIndex: =5

            FormClose_1 As Button:
                Appearance: ='ButtonCanvas.Appearance'.Transparent
                DisplayMode: =DisplayMode.Edit
                FontColor: =RGBA(255, 255, 255, 1)
                FontSize: =27
                Height: =21
                Icon: ="Dismiss"
                OnSelect: =Set(showElement, Blank())
                Text: =
                Width: =26
                X: =339
                Y: =15
                ZIndex: =7

            TextCanvas5_23 As Text:
                DisplayMode: =DisplayMode.Edit
                Height: =32
                Text: |-
                    ="Comment:"
                Weight: ='TextCanvas.Weight'.Semibold
                Width: =160
                X: =FormAlignment
                Y: =292
                ZIndex: =8

            TextCanvas5_15 As Text:
                DisplayMode: =DisplayMode.Edit
                Height: =32
                Text: |-
                    ="Product: "
                Weight: ='TextCanvas.Weight'.Semibold
                Width: =100
                X: =FormAlignment
                Y: =205
                ZIndex: =9

            TextCanvas5_14 As Text:
                DisplayMode: =DisplayMode.Edit
                Height: =32
                Text: =LookUp(product_data, id = CurrentRequestProductId, name)
                Width: =120
                X: =146
                Y: =205
                ZIndex: =10

            TextCanvas5_17 As Text:
                DisplayMode: =DisplayMode.Edit
                Height: =32
                Text: =CurrentRequestProductId
                Width: =120
                X: =146
                Y: =180
                ZIndex: =11

            TextCanvas5_19 As Text:
                DisplayMode: =DisplayMode.Edit
                Height: =32
                Text: =CurrentRequestCreationDate
                Width: =160
                X: =146
                Y: =113
                ZIndex: =12

            TextCanvas5_21 As Text:
                DisplayMode: =DisplayMode.Edit
                Height: =32
                Text: ="$"&CurrentRequestOldPrice
                Weight: ='TextCanvas.Weight'.Regular
                Width: =120
                X: =146
                Y: =230
                ZIndex: =13

            Spinner1_1 As Spinner:
                DisplayMode: =DisplayMode.Edit
                Height: =62
                Visible: =spinnerVis
                Width: =80
                X: =146
                Y: =363
                ZIndex: =14

            TextCanvas5_24 As Text:
                DisplayMode: =DisplayMode.Edit
                Height: =32
                Text: |-
                    ="Creation date:"
                Weight: ='TextCanvas.Weight'.Semibold
                Width: =100
                X: =FormAlignment
                Y: =113
                ZIndex: =15

            TextCanvas5_25 As Text:
                DisplayMode: =DisplayMode.Edit
                Height: =32
                Text: =CurrentRequestReviewDate
                Width: =160
                X: =146
                Y: =139
                ZIndex: =16

            TextCanvas5_22 As Text:
                DisplayMode: =DisplayMode.Edit
                Height: =32
                Text: |-
                    ="Request ID: "
                Weight: ='TextCanvas.Weight'.Semibold
                Width: =100
                X: =FormAlignment
                Y: =62
                ZIndex: =17

            TextCanvas5_26 As Text:
                DisplayMode: =DisplayMode.Edit
                Height: =32
                Text: =CurrentRequestId
                Width: =120
                X: =146
                Y: =62
                ZIndex: =18

            TextCanvas5_27 As Text:
                DisplayMode: =DisplayMode.Edit
                Height: =32
                Text: |-
                    ="New price: "
                Weight: ='TextCanvas.Weight'.Bold
                Width: =100
                X: =FormAlignment
                Y: =255
                ZIndex: =19

            TextCanvas5_28 As Text:
                DisplayMode: =DisplayMode.Edit
                Height: =32
                Text: ="$"&CurrentRequestNewPrice
                Weight: ='TextCanvas.Weight'.Bold
                Width: =120
                X: =146
                Y: =255
                ZIndex: =20

            TextCanvas5_29 As Text:
                DisplayMode: =DisplayMode.Edit
                Height: =32
                Text: |-
                    ="Status: "
                Weight: ='TextCanvas.Weight'.Semibold
                Width: =100
                X: =FormAlignment
                Y: =87
                ZIndex: =21

            TextCanvas5_30 As Text:
                DisplayMode: =DisplayMode.Edit
                Height: =32
                Text: =CurrentRequestStatus
                Width: =120
                X: =146
                Y: =87
                ZIndex: =22

            BtnAccept As group:
                Height: =5
                Width: =5
                X: =40
                Y: =40
                ZIndex: =27

                Circle1 As circle:
                    BorderColor: =RGBA(214, 221, 224, 1)
                    BorderThickness: =1
                    DisplayMode: |-
                        =If(
                            And(CurrentRequestStatus = "Pending", User().FullName = "ADAM JOHN"),
                            DisplayMode.Edit,
                            DisplayMode.View
                        )
                    Fill: =RGBA(0, 0, 0, 0)
                    Height: =34
                    Width: =35
                    X: =121
                    Y: =452
                    ZIndex: =23

                AcceptButton As Button:
                    Appearance: ='ButtonCanvas.Appearance'.Transparent
                    DisplayMode: |-
                        =If(
                            And(CurrentRequestStatus = "Pending", CurrentUserRole = "manager"),
                            DisplayMode.Edit,
                            DisplayMode.View
                        )
                    FontColor: =RGBA(72, 163, 62, 1)
                    Height: =32
                    Icon: ="Checkmark"
                    IconStyle: ='ButtonCanvas.IconStyle'.Filled
                    OnSelect: |-
                        =IfError(
                        
                            // Update request
                            Patch(
                                requests,
                                First(Filter(requests, product_id = CurrentRequestProductId && status = "Pending")),
                                {review_date: Now(), status: "Accepted"}
                            ),
                            Notify("Couldn't update the request from ""Pending"" to ""Accepted""", NotificationType.Error),
                        
                            // Update product with the "Current" status
                            Patch(
                                product_data,
                                First(Filter(product_data, id = Int(CurrentRequestProductId) && status = "Current")),
                                {end_date: Now(), status: "Expired"}
                            ),
                            Notify("Couldn't update the product data from ""Current"" to ""Expired""", NotificationType.Error),
                        
                            // Add the product new record
                            Patch(
                                product_data,
                                Defaults(product_data),
                                {name: LookUp(product_data, id = CurrentRequestProductId, name), id: Int(CurrentRequestProductId), price: CurrentRequestNewPrice, start_date: Now(), end_date: Date(9999, 12, 31), status: "Current"}
                            ),
                            Notify("Couldn't add the new product data", NotificationType.Error)
                        );
                        Notify("Request was successfully accepted", NotificationType.Success); // Display success message only if all the Patches pass
                        
                        Set(showElement, Blank()) // Closes the form window
                    Text: =
                    Visible: =true
                    Width: =33
                    X: =122
                    Y: =453
                    ZIndex: =26

            BtnReject As group:
                Height: =5
                Width: =5
                X: =40
                Y: =40
                ZIndex: =27

                Circle1_1 As circle:
                    BorderColor: =RGBA(214, 221, 224, 1)
                    BorderThickness: =1
                    DisplayMode: |-
                        =If(
                            CurrentRequestStatus in ("Accepted"),
                            DisplayMode.View,
                            DisplayMode.Edit
                        )
                    Fill: =Color.Transparent
                    Height: =34
                    Width: =35
                    X: =209
                    Y: =453
                    ZIndex: =24

                RejectButton As Button:
                    Appearance: ='ButtonCanvas.Appearance'.Transparent
                    DisplayMode: |-
                        =If(
                            And(CurrentRequestStatus = "Pending", Or(CurrentUserRole = "manager", CurrentUserId = CurrentRequestEmployeeId)),
                            DisplayMode.Edit,
                            DisplayMode.View
                        )
                    FontColor: =RGBA(215, 58, 60, 1)
                    Height: =32
                    Icon: ="Dismiss"
                    IconStyle: ='ButtonCanvas.IconStyle'.Filled
                    OnSelect: |-
                        =IfError(
                            If(
                                CurrentUserRole = "manager", // Checks if the user is the BU Manager
                                Patch(
                                    requests,
                                    First(Filter(requests, product_id = CurrentRequestProductId && status = "Pending")),
                                    {review_date: Now(), status: "Rejected", reviewer_comment: reviewComment.comment}
                                );
                                Notify("Request was successfully rejected", NotificationType.Success),
                        
                                CurrentUserId = CurrentRequestEmployeeId, // Checks if the user is the request author
                                Patch(
                                    requests,
                                    First(Filter(requests, product_id = CurrentRequestProductId && status = "Pending")),
                                    {review_date: Now(), status: "Canceled", reviewer_comment: reviewComment.comment}
                                );
                                Notify("Request was successfully canceled", NotificationType.Success)
                            ),
                            Notify("Couldn't update the request", NotificationType.Error)
                        );
                        
                        Set(showElement, Blank()) // Closes the form window
                    Text: =
                    Visible: =true
                    Width: =35
                    X: =209
                    Y: =455
                    ZIndex: =25

            reviewCommentFixed As Text:
                DisplayMode: =DisplayMode.Edit
                Height: =32
                Text: =LookUp(requests, id = CurrentRequestId, reviewer_comment)
                Visible: |-
                    =If(
                        CurrentRequestStatus <> "Pending",
                        true,
                        false
                    )
                Width: =295
                X: =37
                Y: =376
                ZIndex: =31

            requesterComment As Text:
                DisplayMode: =DisplayMode.Edit
                Height: =32
                Text: =LookUp(requests, id = CurrentRequestId, requester_comment)
                Visible: =true
                Width: =295
                X: =35
                Y: =317
                ZIndex: =32

            reviewComment As formComment:
                label: |-
                    ="Review:"
                Visible: =true
                X: =FormAlignment
                Y: =354
                ZIndex: =33

    filters As group:
        Height: =5
        Width: =5
        X: =40
        Y: =40
        ZIndex: =24

        filterLabel_1 As filterLabel:
            Text: ="Name/ID"
            X: =304
            Y: =154
            ZIndex: =4

        filterLabel_2 As filterLabel:
            Text: ="Status"
            X: =712
            Y: =154
            ZIndex: =5

        filterLabel_3 As filterLabel:
            Text: ="Requests"
            X: =888
            Y: =153
            ZIndex: =6

        searchBar_request As searchBar:
            X: =304
            Y: =194
            ZIndex: =7

        filterDD_Status As filterDD:
            Values: =Table(["All", "Pending", "Accepted", "Rejected", "Canceled"])
            X: =712
            Y: =194
            ZIndex: =8

        filterDD_Employee As filterDD:
            Values: =Table(["All requests", "My requests"])
            X: =888
            Y: =194
            ZIndex: =9

    countFooter As group:
        Height: =5
        Width: =5
        X: =40
        Y: =40
        ZIndex: =24

        Rectangle1 As rectangle:
            BorderColor: =App.Theme.Colors.Darker40
            Fill: =Color.White
            Height: =29
            Width: =756
            X: =304
            Y: =662
            ZIndex: =10

        TextCanvas1 As Text:
            Align: ='TextCanvas.Align'.Center
            DisplayMode: =DisplayMode.Edit
            FontColor: =RGBA(106, 122, 127, 1)
            Height: =29
            Size: =10
            Text: |-
                =If(
                    GalleryRequests.AllItemsCount <= 1,
                    GalleryRequests.AllItemsCount&" request",
                    GalleryRequests.AllItemsCount&" requests"
                )
            Width: =756
            X: =304
            Y: =662
            ZIndex: =11

        sectionSeparator_1 As icon.VerticalLine:
            BorderColor: =App.Theme.Colors.Lighter10
            Color: =RGBA(0, 0, 0, 0)
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(244, 244, 244, 1)
            Fill: =Color.LightGray
            FocusedBorderThickness: =0
            Height: =0.1
            Icon: =Icon.HorizontalLine
            Width: =756
            X: =304
            Y: =662
            ZIndex: =12

